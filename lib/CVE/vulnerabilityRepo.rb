require 'HTTParty'
require 'open-uri'
require 'Nokogiri'
require 'pry'

require_relative './version'

class CVE::VulnerabilityRepo
  attr_accessor :name, :text, :date, :year, :references
  @CVE_LIST = nil
  CVEs = []
  
  def initialize(attributes = nil)
    #binding.pry
    @name = attributes.to_str.split("\n")[1] if attributes != nil
    @text = attributes.to_str 
    # Regex to select element that begins with http or https for reference
    @references = attributes.to_str.split("\n").select {|reference| reference[/https?:/]} if attributes != nil
    # Regex to select element that begins with http or https for date
    @date = attributes.to_str.split("\n").select {|date| date[/\d{4}.\d{2}.\d{2}/]} if attributes != nil
    #binding.pry
    CVEs << self
    @CVE_LIST = CVEs
  end

  def self.new_from_page(attributes)
    self.new(attributes)
  end

  # gets used in cli when WebScraper is created
  #def parse(year)
  #  @year = year
  #  page = 'https://cve.mitre.org/data/downloads/allitems-cvrf-year-'+year+'.xml'

  #  parse_page = Nokogiri::HTML(open(page))
    
  #  container = []
  #  parse_page.search('vulnerability').map do |element| 
  #    container << element.text
  #  end

  #  @CVE_LIST = container
    #binding.pry
  #end

  #def create
  #  @CVE_LIST.each do |attributes|
  #    VulnerabilityRepo.new(attributes)
  #  end
  #end

  def clear
    @CVE_LIST.clear
  end


  def self.all
    CVEs
  end

  # method that allows user to get date, and if no date get the text for CVE
  def getDate
    self.date == nil || self.date == [] ? "No date. #{self.text}" : self.date
  end

  # method that allows user to search for specific vulnerability based on name
  def self.findByName(name)
    self.all.select {|vulnerability| name == vulnerability.name}
  end 

  #create method that allows user to see vulnerabilities based on month which is a two char string
  def self.findByMonth(month)
    vulnerabilities = self.all.reject {|vulnerability| vulnerability.date == []}
    #binding.pry
    result = vulnerabilities.select {|vulnerability| month == vulnerability.date.first.split("-")[1]}
    #binding.pry
    result.each {|x| puts x.text}
  end

  #create method that allows user to find all microsoft vulnerabilities or anything that contains user input(like a search)
  def self.search(text)
    #binding.pry
    result = self.all.select {|vulnerability| vulnerability.text.include?(text)}
    #binding.pry
    result.each {|x| puts x.text}
  end
end